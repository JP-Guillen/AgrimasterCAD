@page "/admin/notificaciones"
@attribute [Authorize(Roles = "Administrador")]
@rendermode InteractiveServer

@inject AuthenticationStateProvider authenticationStateProvider
@inject NotificacionesService notificacionesService
@inject NavigationManager navigationManager

<div class="container py-5">
    <div class="card shadow-lg">
        <div class="card-header text-center">
            <h4 class="card-title fw-bold">Notificaciones</h4>
        </div>

        <div class="card-body">
            @if (notificaciones.Any())
            {
                <div class="d-flex justify-content-end mb-3 gap-2">
                    <button class="btn btn-sm btn-success"
                            @onclick="MarcarTodasLeidas">
                        <i class="bi bi-check2-all"></i> Marcar todas como leídas
                    </button>

                    @if (notificaciones.All(n => n.Leida))
                    {
                        <button class="btn btn-sm btn-danger"
                                @onclick="EliminarTodas">
                            <i class="bi bi-trash"></i> Eliminar todas
                        </button>
                    }
                </div>
            }

            @if (notificaciones.Count == 0)
            {
                <p class="text-center text-muted">No tienes notificaciones.</p>
            }
            else
            {
                @foreach (var notificacion in notificacionesPaginadas)
                {
                    <div class="alert @(notificacion.Leida ? "alert-secondary" : "alert-primary") shadow-sm small">
                        
                        <h5 class="fw-bold mb-1">@notificacion.Titulo</h5>

                        <p class="mb-1">@notificacion.Mensaje</p>

                        <small class="text-muted">
                            @notificacion.Fecha.ToString("dd/MM/yyyy hh:mm tt")
                        </small>

                        <div class="mt-2 d-flex justify-content-end gap-2">
                            @if (!notificacion.Leida)
                            {
                                <button class="btn btn-sm btn-success"
                                        @onclick="() => MarcarLeida(notificacion.NotificacionId)">
                                    <i class="bi bi-check-circle"></i> Marcar leída
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => Eliminar(notificacion.NotificacionId)">
                                    <i class="bi bi-x-lg"></i> Eliminar
                                </button>
                            }
                        </div>
                    </div>
                }

                <nav class="mt-3">
                    <ul class="pagination justify-content-center">

                        <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)">Anterior</button>
                        </li>

                        <li class="page-item active">
                            <button class="page-link">@paginaActual de @totalPaginas</button>
                        </li>

                        <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)">Siguiente</button>
                        </li>

                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

@code {
    private List<Notificaciones> notificaciones = new();
    private List<Notificaciones> notificacionesPaginadas = new();

    private string? userId;

    private int paginaActual = 1;
    private int elementosPorPagina = 6;
    private int totalPaginas = 1;

    protected override async Task OnInitializedAsync()
    {
        var state = await authenticationStateProvider.GetAuthenticationStateAsync();
        userId = state.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

       if (userId == null)
        {
            navigationManager.NavigateTo("/Account/Login");
            return;
        }

        await CargarNotificaciones();
    }

    private async Task CargarNotificaciones()
    {
        var todas = await notificacionesService.Listar(userId!);

        notificaciones = todas
            .OrderBy(n => n.Leida)
            .ThenByDescending(n => n.Fecha)
            .ToList();

        totalPaginas = Math.Max(1, (int)Math.Ceiling(notificaciones.Count / (double)elementosPorPagina));

        CambiarPagina(1);
    }

    private void CambiarPagina(int pagina)
    {
        if (pagina < 1 || pagina > totalPaginas)
            return;

        paginaActual = pagina;

        notificacionesPaginadas = notificaciones
            .Skip((paginaActual - 1) * elementosPorPagina)
            .Take(elementosPorPagina)
            .ToList();
    }

    private async Task MarcarLeida(int id)
    {
        await notificacionesService.MarcarLeida(id);
        await CargarNotificaciones();
    }

    private async Task MarcarTodasLeidas()
    {
        await notificacionesService.MarcarTodasLeidas(userId!);
        await CargarNotificaciones();
    }

    private async Task Eliminar(int id)
    {
        await notificacionesService.Eliminar(id);
        await CargarNotificaciones();
    }

    private async Task EliminarTodas()
    {
        await notificacionesService.EliminarTodas(userId!);
        await CargarNotificaciones();
    }
}
