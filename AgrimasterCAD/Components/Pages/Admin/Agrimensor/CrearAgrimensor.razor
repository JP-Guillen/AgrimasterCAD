@page "/admin/crear-agrimensor"
@layout AppLayout
@attribute [Authorize(Roles = "Administrador")]
@rendermode InteractiveServer

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Crear Agrimensor</PageTitle>

<EditForm Model="agrimensor" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container py-5">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h4 class="card-title fw-bold">Crear Agrimensor</h4>
            </div>

            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Nombre Completo</label>
                    <InputText class="form-control" @bind-Value="agrimensor.NombreCompleto" />
                    <ValidationMessage For="(() => agrimensor.NombreCompleto)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Cédula</label>
                    <InputText class="form-control" @bind-Value="agrimensor.NumeroCedula" />
                    <ValidationMessage For="(() => agrimensor.NumeroCedula)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Ciudad</label>
                    <InputText class="form-control" @bind-Value="agrimensor.Ciudad" />
                    <ValidationMessage For="(() => agrimensor.Ciudad)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Dirección</label>
                    <InputText class="form-control" @bind-Value="agrimensor.Direccion" />
                    <ValidationMessage For="(() => agrimensor.Direccion)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Número CODIA</label>
                    <InputText class="form-control" @bind-Value="agrimensor.NumeroCodia" />
                    <ValidationMessage For="(() => agrimensor.NumeroCodia)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Correo electrónico</label>
                    <InputText class="form-control" @bind-Value="agrimensor.Email" />
                    <ValidationMessage For="(() => agrimensor.Email)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Teléfono</label>
                    <InputText class="form-control" @bind-Value="agrimensor.PhoneNumber" />
                    <ValidationMessage For="(() => agrimensor.PhoneNumber)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Contraseña</label>
                    <InputText type="password" class="form-control" @bind-Value="agrimensor.Password" />
                    <ValidationMessage For="(() => agrimensor.Password)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Confirmar Contraseña</label>
                    <InputText type="password" class="form-control" @bind-Value="agrimensor.ConfirmPassword" />
                    <ValidationMessage For="(() => agrimensor.ConfirmPassword)" />
                </div>

                @if (!string.IsNullOrEmpty(errorMensaje))
                {
                    <div class="alert alert-danger">@errorMensaje</div>
                }
            </div>

            <div class="card-footer">
                <div class="d-flex justify-content-center gap-2">
                    <a href="/admin/agrimensores" class="btn btn-secondary">
                        <span class="bi bi-arrow-left"></span> Volver
                    </a>

                    <button class="btn btn-success" type="submit" disabled="@(guardando)">
                        <i class="bi bi-floppy"></i> @(guardando ? "Guardando..." : "Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private AgrimensorInputModel agrimensor = new();
    private string? errorMensaje;
    private bool guardando = false;

    private async Task Guardar()
    {
        guardando = true;
        errorMensaje = string.Empty;

        try
        {
            var usuario = new ApplicationUser
            {
                NombreCompleto = agrimensor.NombreCompleto,
                NumeroCedula = agrimensor.NumeroCedula,
                Ciudad = agrimensor.Ciudad,
                Direccion = agrimensor.Direccion,
                PhoneNumber = agrimensor.PhoneNumber,
                Email = agrimensor.Email,
                UserName = agrimensor.Email,
                NumeroCodia = agrimensor.NumeroCodia,
            };

            var result = await UserManager.CreateAsync(usuario, agrimensor.Password);

            if (!result.Succeeded)
            {
                errorMensaje = string.Join(" | ", result.Errors.Select(e => e.Description));
                guardando = false;
                return;
            }

            await UserManager.AddToRoleAsync(usuario, "Agrimensor");

            Navigation.NavigateTo("/admin/agrimensores");
        }
        catch (Exception ex)
        {
            errorMensaje = "Error inesperado: " + ex.Message;
        }
        finally
        {
            guardando = false;
        }
    }

    public class AgrimensorInputModel
    {
        [Required(ErrorMessage = "El campo Nombre Completo es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚÑáéíóúñ ]{2,80}$", ErrorMessage = "El nombre solo puede contener letras y espacios.")]
        [StringLength(150, ErrorMessage = "El nombre no puede superar los 150 caracteres.")]
        public string NombreCompleto { get; set; } = "";

        [Required(ErrorMessage = "El campo Cédula es obligatorio.")]
        [RegularExpression(@"^\d{3}-\d{7}-\d{1}$", ErrorMessage = "El número de cédula debe tener el formato ###-#######-#.")]
        public string NumeroCedula { get; set; } = "";

        [Required(ErrorMessage = "El campo Ciudad es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$", ErrorMessage = "La ciudad solo puede contener letras y espacios.")]
        [StringLength(80, ErrorMessage = "La ciudad no puede superar los 80 caracteres.")]
        public string Ciudad { get; set; } = "";

        [Required(ErrorMessage = "El campo Dirección es obligatorio.")]
        [RegularExpression(pattern: @"^[A-Za-z0-9ÁÉÍÓÚÑáéíóúñ #.,\-]+$", ErrorMessage = "La dirección contiene caracteres no válidos.")]
        [StringLength(120, ErrorMessage = "La dirección no puede superar los 120 caracteres.")]
        public string Direccion { get; set; } = "";

        [Required(ErrorMessage = "El número CODIA es obligatorio.")]
        [RegularExpression(@"^\d+$", ErrorMessage = "El número CODIA debe contener solo números.")]
        [StringLength(10, ErrorMessage = "El número CODIA no puede superar los 10 dígitos.")]
        public string NumeroCodia { get; set; } = "";

        [Required(ErrorMessage = "El campo Teléfono es obligatorio.")]
        [RegularExpression(@"^\+?[0-9\s\-()]{7,20}$", ErrorMessage = "El número de teléfono no es válido.")]
        public string PhoneNumber { get; set; } = "";

        [Required(ErrorMessage = "El campo Correo electrónico es obligatorio.")]
        [EmailAddress(ErrorMessage = "El correo electrónico no es válido.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "El campo Contraseña es obligatorio.")]
        [StringLength(100, ErrorMessage = "La contraseña debe tener entre {2} y {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "Las contraseñas no coinciden.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
