@page "/admin/crear-agrimensor"
@attribute [Authorize(Roles = "Administrador")]
@rendermode InteractiveServer

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Crear Agrimensor</PageTitle>

<EditForm Model="modelo" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container mt-4">
        <div class="card shadow">
            <div class="card-header">
                <h4 class="card-title"><strong>Crear Agrimensor</strong></h4>
            </div>

            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Nombre Completo</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.NombreCompleto" />
                    <ValidationMessage For="(() => modelo.NombreCompleto)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Cédula</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.NumeroCedula" />
                    <ValidationMessage For="(() => modelo.NumeroCedula)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Ciudad</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.Ciudad" />
                    <ValidationMessage For="(() => modelo.Ciudad)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Dirección</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.Direccion" />
                    <ValidationMessage For="(() => modelo.Direccion)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Número CODIA</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.NumeroCodia" />
                    <ValidationMessage For="(() => modelo.NumeroCodia)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Correo</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.Email" />
                    <ValidationMessage For="(() => modelo.Email)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Teléfono</strong></label>
                    <InputText class="form-control" @bind-Value="modelo.PhoneNumber" />
                    <ValidationMessage For="(() => modelo.PhoneNumber)" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Contraseña</strong></label>
                    <InputText type="password" class="form-control" @bind-Value="password" />
                    <ValidationMessage For="(() => password)" />
                </div>

                @if (!string.IsNullOrEmpty(errorMensaje))
                {
                    <div class="alert alert-danger">
                        @errorMensaje
                    </div>
                }
            </div>

            <div class="card-footer">
                <div class="d-flex justify-content-center gap-2">
                    <a href="/admin/agrimensores" class="btn btn-secondary">
                        <span class="bi bi-arrow-left"></span> Volver
                    </a>

                    <button class="btn btn-success" type="submit" disabled="@(guardando)">
                        <i class="bi bi-floppy"></i> @(guardando ? "Guardando..." : "Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private ApplicationUser modelo = new();
    private string password = string.Empty;
    private string errorMensaje = string.Empty;
    private bool isLoading = false;

    private bool CamposIncompletos() =>
        string.IsNullOrWhiteSpace(modelo.NombreCompleto) ||
        string.IsNullOrWhiteSpace(modelo.NumeroCedula) ||
        string.IsNullOrWhiteSpace(modelo.Ciudad) ||
        string.IsNullOrWhiteSpace(modelo.Direccion) ||
        string.IsNullOrWhiteSpace(modelo.Email) ||
        string.IsNullOrWhiteSpace(modelo.PhoneNumber) ||
        string.IsNullOrWhiteSpace(password);

    private async Task Guardar()
    {
        guardando = true;
        errorMensaje = string.Empty;

        try
        {
            var usuario = new ApplicationUser
            {
                UserName = modelo.Email,
                PhoneNumber = modelo.PhoneNumber,
                Email = modelo.Email,
                NombreCompleto = modelo.NombreCompleto,
                NumeroCedula = modelo.NumeroCedula,
                Ciudad = modelo.Ciudad,
                Direccion = modelo.Direccion,
                NumeroCodia = modelo.NumeroCodia,
            };

            var result = await UserManager.CreateAsync(usuario, password);

            if (!result.Succeeded)
            {
                errorMensaje = string.Join(" | ", result.Errors.Select(e => e.Description));
                guardando = false;
                return;
            }

            await UserManager.AddToRoleAsync(usuario, "Agrimensor");

            Navigation.NavigateTo("/admin/agrimensores");
        }
        catch (Exception ex)
        {
            errorMensaje = "Error inesperado: " + ex.Message;
        }
        finally
        {
            guardando = false;
        }
    }

    public class AgrimensorInputModel
    {
        [Required(ErrorMessage = "El campo Nombre Completo es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚÑáéíóúñ ]{2,80}$", ErrorMessage = "El nombre solo puede contener letras y espacios.")]
        [StringLength(150, ErrorMessage = "El nombre no puede superar los 150 caracteres.")]
        public string NombreCompleto { get; set; } = "";

        [Required(ErrorMessage = "El campo Cédula es obligatorio.")]
        [RegularExpression(@"^\d{3}-\d{7}-\d{1}$", ErrorMessage = "El número de cédula debe tener el formato ###-#######-#.")]
        public string NumeroCedula { get; set; } = "";

        [Required(ErrorMessage = "El campo Ciudad es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚÑáéíóúñ ]+$", ErrorMessage = "La ciudad solo puede contener letras y espacios.")]
        [StringLength(80, ErrorMessage = "La ciudad no puede superar los 80 caracteres.")]
        public string Ciudad { get; set; } = "";

        [Required(ErrorMessage = "El campo Dirección es obligatorio.")]
        [RegularExpression(pattern: @"^[A-Za-z0-9ÁÉÍÓÚÑáéíóúñ #.,\-]+$", ErrorMessage = "La dirección contiene caracteres no válidos.")]
        [StringLength(120, ErrorMessage = "La dirección no puede superar los 120 caracteres.")]
        public string Direccion { get; set; } = "";

        [Required(ErrorMessage = "El número CODIA es obligatorio.")]
        [RegularExpression(@"^\d+$", ErrorMessage = "El número CODIA debe contener solo números.")]
        [StringLength(10, ErrorMessage = "El número CODIA no puede superar los 10 dígitos.")]
        public string NumeroCodia { get; set; } = "";

        [Required(ErrorMessage = "El campo Teléfono es obligatorio.")]
        [RegularExpression(@"^\+?[0-9\s\-()]{7,20}$", ErrorMessage = "El número de teléfono no es válido.")]
        public string PhoneNumber { get; set; } = "";

        [Required(ErrorMessage = "El campo Correo electrónico es obligatorio.")]
        [EmailAddress(ErrorMessage = "El correo electrónico no es válido.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "El campo Contraseña es obligatorio.")]
        [StringLength(100, ErrorMessage = "La contraseña debe tener entre {2} y {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "Las contraseñas no coinciden.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
