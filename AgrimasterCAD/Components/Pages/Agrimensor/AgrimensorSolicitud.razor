@page "/agrimensor/solicitud/{SolicitudId:int}"
@attribute [Authorize(Roles = "Agrimensor")]
@rendermode InteractiveServer

@inject SolicitudesService solicitudesService
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager navigationManager

<PageTitle>Detalle de Solicitud</PageTitle>

<div class="container">
    <div class="card shadow-lg">
        <div class="card-header text-center">
            <h4 class="card-title fw-bold">
                <i class="bi bi-file-text-fill me-2"></i> Detalles de la Solicitud #@SolicitudId
            </h4>
        </div>

        <div class="card-body">

            @if (cargando)
            {
                <div class="text-center my-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3">Cargando la solicitud...</p>
                </div>
            }
            else
            {
                @if (!PuedeEditar)
                {
                    <div class="alert alert-info text-center fw-bold">
                         Esta solicitud no puede editarse en su estado actual: <b>@solicitud!.Estado</b>.
                    </div>
                }

                <h5 class="fw-bold mb-3">Informaci贸n General</h5>

                <div class="row g-3 mb-3">

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Estado</label>
                        <input class="form-control" value="@solicitud!.Estado" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Cliente</label>
                        <input class="form-control" value="@solicitud.Cliente!.NombreCompleto" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Fecha Solicitud</label>
                        <input class="form-control" value="@solicitud.Fecha.ToString("dd/MM/yyyy")" disabled />
                    </div>
                </div>

                <hr />

                <h5 class="fw-bold mb-3">Informaci贸n del Cliente</h5>

                <div class="row g-3 mb-3">

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Nombre Completo</label>
                        <input class="form-control" value="@solicitud.Cliente!.NombreCompleto" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">C茅dula</label>
                        <input class="form-control" value="@solicitud.Cliente!.NumeroCedula" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tel茅fono</label>
                        <input class="form-control" value="@solicitud.Cliente!.PhoneNumber" disabled />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Email</label>
                        <input class="form-control" value="@solicitud.Cliente!.Email" disabled />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Direcci贸n</label>
                        <input class="form-control" value="@solicitud.Cliente!.Direccion" disabled />
                    </div>
                </div>

                <hr />

                <h5 class="fw-bold mb-3">Ubicaci贸n</h5>

                <div class="row g-3 mb-3">

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Provincia</label>
                        <input class="form-control" value="@solicitud.Provincia" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Municipio</label>
                        <input class="form-control" value="@solicitud.Municipio" disabled />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Direcci贸n</label>
                        <input class="form-control" value="@solicitud.Direccion" disabled />
                    </div>
                </div>

                <hr />

                <h5 class="fw-bold mb-3">Documentos del Cliente</h5>

                @if (solicitud.Documentos != null && solicitud.Documentos.Any())
                {
                    @foreach (var documento in solicitud.Documentos)
                    {
                        <p>
                            <b>@documento.Tipo:</b>
                            <a class="btn btn-link" href="@documento.RutaArchivo" target="_blank">
                                Ver PDF
                            </a>
                        </p>
                    }
                }
                else
                {
                    <p class="text-muted">No hay documentos disponibles.</p>
                }

                <hr />

                <h5 class="fw-bold mb-3">Plano</h5>

                @if (solicitud.Plano != null)
                {
                    <a href="@solicitud.Plano.RutaArchivo" class="btn btn-info" target="_blank">
                        Ver Plano
                    </a>
                }
                else
                {
                    <p class="text-muted">No se ha subido un plano a煤n.</p>
                }

                @if (PuedeEditar)
                {
                    <div class="mt-3">
                        <label class="form-label fw-bold">Subir/Actualizar Plano</label>
                        <InputFile class="form-control" OnChange="CargarPlano" accept="application/pdf" />

                        @if (!string.IsNullOrEmpty(errorPlano))
                        {
                            <div class="alert alert-danger mt-2">@errorPlano</div>
                        }
                    </div>
                }

                <hr />

                <h5 class="fw-bold mb-3">Costo Final</h5>

                @if (PuedeEditar)
                {
                    <InputNumber class="form-control mb-2" @bind-Value="costoFinal" />

                    @if (!string.IsNullOrEmpty(errorCosto))
                    {
                        <div class="alert alert-danger mt-2">@errorCosto</div>
                    }
                }
                else
                {
                    <input class="form-control" value="@(solicitud.CostoFinal?.ToString("C", new CultureInfo("es-DO")) ?? "Pendiente")" disabled />
                }

                <hr />

                <h5 class="fw-bold mb-3">Seguimiento</h5>

                @if (solicitud.Seguimientos == null || !solicitud.Seguimientos.Any())
                {
                    <p class="text-muted">No hay seguimiento registrado.</p>
                }
                else
                {
                    @foreach (var seguimiento in solicitud.Seguimientos.OrderByDescending(s => s.Fecha))
                    {
                        <div class="alert alert-secondary">
                            <b>@seguimiento.Fecha.ToString("dd/MM/yyyy HH:mm"):</b>
                            @seguimiento.Comentario
                        </div>
                    }
                }

                @if (PuedeEditar)
                {
                    <textarea class="form-control mb-2" placeholder="Nuevo comentario..." @bind="nuevoSeguimiento"></textarea>
                }
            }
        </div>

        <div class="card-footer text-center">
            <a href="/agrimensor/solicitudes" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>

            @if (PuedeEditar)
            {
                <button class="btn btn-success" @onclick="Guardar">
                    <i class="bi bi-floppy"></i> Guardar
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int SolicitudId { get; set; }

    private Solicitudes? solicitud;
    private bool cargando = true;

    private decimal? costoFinal;
    private string? nuevoSeguimiento;
    private IBrowserFile? archivoPlano;

    private string? errorCosto;
    private string? errorPlano;

    private bool PuedeEditar => solicitud?.Estado == "En Proceso";

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (userId == null)
        {
            navigationManager.NavigateTo("/Account/Login");
            return;
        }

        solicitud = await solicitudesService.Buscar(SolicitudId);

        if (solicitud == null)
        {
            navigationManager.NavigateTo("/not-found");
            return;
        }

        bool puedeVer = solicitud.Estado == "Pendiente" || solicitud.AgrimensorId == userId;

        if (!puedeVer)
        {
            navigationManager.NavigateTo("/not-found");
            return;
        }

        costoFinal = solicitud.CostoFinal;

        cargando = false;
    }

    private void CargarPlano(InputFileChangeEventArgs e)
    {
        var archivo = e.File;

        if (!archivo.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            errorPlano = "El archivo debe ser un PDF.";
            archivoPlano = null;
            return;
        }

        if (archivo.Size > 5 * 1024 * 1024)
        {
            errorPlano = "El plano no puede superar los 5 MB.";
            archivoPlano = null;
            return;
        }

        errorPlano = null;
        archivoPlano = archivo;
    }

    private async Task Guardar()
        {
            bool quiereSubirPlano = archivoPlano != null;
            bool quiereGuardarCosto = costoFinal.HasValue && costoFinal > 0;

            if (quiereSubirPlano && !quiereGuardarCosto)
            {
                errorPlano = "Debe ingresar el costo final para guardar el plano.";
                return;
            }

            if (quiereGuardarCosto && !quiereSubirPlano && solicitud!.Plano == null)
            {
                errorCosto = "Debe subir el plano para guardar el costo final.";
                return;
            }

            errorPlano = null;
            errorCosto = null;

            if (!string.IsNullOrWhiteSpace(nuevoSeguimiento))
            {
                await solicitudesService.AgregarSeguimiento(SolicitudId, nuevoSeguimiento);
                nuevoSeguimiento = "";
            }

            if (quiereSubirPlano)
            {
                await solicitudesService.GuardarPlano(SolicitudId, archivoPlano!);
            }

            if (quiereGuardarCosto)
            {
                solicitud!.CostoFinal = costoFinal!.Value;
            }

            if (quiereSubirPlano && quiereGuardarCosto)
            {
                solicitud!.Estado = "Pago Pendiente";
            solicitud.Estado = "Pago Pendiente";
            }

            await solicitudesService.Guardar(solicitud!);

            navigationManager.NavigateTo($"/agrimensor/solicitud/{SolicitudId}", true);
    }
}
